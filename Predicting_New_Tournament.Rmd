---
title: "GolfForecast - Predicting new week"
author: "Álvaro Orgaz Expósito"
date: "5 February 2019"
output: html_document
---

# Input Azure

```{r}
# data <- maml.mapInputPort(1)
data <- read.csv2(file="Data.csv",header=TRUE,na.strings="",sep=",",dec=".")
data <- as.data.frame(data)
data <- data[order(data$Week),]
```

# Preparing data (lagged variables) for predicting: RankingPoints with previous 20 RankingPoints

Bins of RankingPoints for binning the feature later and help the model to find correlations.
```{r}
breaks_points <- c(0,1,2,5,100)
```

Maximum lag of 20 weeks ago:
- Mean of best 5 values
- Mean of worst 5 values
- Iterate every row of data and create 20 columns or lagged features with previous values for the golfer
- Add the binning of features
- Add mean value for groups of 5 previous weeks (without considering missings -9999)
- Add variance of lagged features or previous values
```{r}
target <- "RankingPoints"
max_lag <- 20
week_to_predict <- 1
data_points_lag20 <- matrix(ncol=5+max_lag)
for(i in 1:nrow(data)){
  golfer <- data[i,"GolferID"]
  week <- data[i,"Week"]
  value <- NA # Unknown, we want to predict
  if(week==week_to_predict){ # We only want to predict week to predict
      data_golfer <- data[data$GolferID==golfer,]
      # Mean of best 5 values
      best_values <- ifelse(target=="RankingPoints",
                             mean(data_golfer[order(-data_golfer[,target])[1:5],target],na.rm=TRUE),
                             mean(data_golfer[order(data_golfer[,target])[1:5],target],na.rm=TRUE))
      best_values <- ifelse(is.na(best_values),-9999,best_values)
      # Mean of worst 5 values
      worst_values <- ifelse(target=="RankingPoints",
                              mean(data_golfer[order(data_golfer[,target])[1:5],target],na.rm=TRUE),
                              mean(data_golfer[order(-data_golfer[,target])[1:5],target],na.rm=TRUE))
      worst_values <- ifelse(is.na(worst_values),-9999,worst_values)
      # Lags
      lagged_values <- c()
      for(lag in 1:max_lag){
        lagged_value <- mean(data_golfer[data_golfer$Week==(week+lag),target]) # Mean because some golfers
                                                                               # compete twice per week
        lagged_value <- ifelse(is.na(lagged_value),-9999,lagged_value) # We impute -9999 if golfer did not
                                                                       # compete or compete but missing value
        lagged_values <- c(lagged_values,lagged_value)
      }
      new_row <- c(golfer,week,value,best_values,worst_values,lagged_values)
      data_points_lag20 <- rbind(data_points_lag20,new_row)
  }
}
data_points_lag20 <- as.data.frame(data_points_lag20[2:nrow(data_points_lag20),])
lagged_features <- paste0(target,"_Lag",1:max_lag)
colnames(data_points_lag20) <- c("Golfer","Week",target,"Bests","Worsts",lagged_features)

# Binning lagged features
for(feature in lagged_features){
  binned_feature <- cut(x=data_points_lag20[,feature],breaks=breaks_points,include.lowest=TRUE)
  levels(binned_feature) <- c("-9999",levels(binned_feature))
  binned_feature[is.na(binned_feature)] <- "-9999"
  data_points_lag20[,paste0(feature,"_Bin")] <- as.numeric(binned_feature) # Label encoding for model
}

# Add mean value for groups of 5 previous weeks (without considering missings -9999)
auxiliar_mean <- function(x) ifelse(!is.na(mean(x[!x==-9999])),mean(x[!x==-9999]),-9999)
for(lag in seq(1,max_lag,5)){
  data_points_lag20[,paste0(target,"_Lag",lag,"to",lag+4)] <- apply(data_points_lag20[,lagged_features[lag:(lag+4)]],
                                                                      1,auxiliar_mean)
}

# Add variance of lagged features or previous values
auxiliar_var <- function(x) ifelse(!is.na(var(x[!x==-9999])),var(x[!x==-9999]),-9999)
data_points_lag20[,"Variance"] <- apply(data_points_lag20[,lagged_features],1,auxiliar_var)
```

# Load trained models
```{r}
library(xgboost)
model_XGB <- xgb.load(paste0("Models/Model_points_lag20_param267.model"))
# Load trained model in zip file
# model_XGB <- xgb.load("./src/Model_points_lag20_param267.model")
```

# Resume of features

```{r}
features_id <- c("Golfer","Week")
target_position <- "Position"
target_points <- "RankingPoints"
features_position_lag15 <- c("Bests","Worsts",
                             paste0("Position_Lag",1:15),
                             paste0("Position_Lag",1:15,"_Bin"),
                             sapply(seq(1,15,5),function(lag) paste0("Position_Lag",lag,"to",lag+4)),
                             "Variance")
features_position_lag20 <- c("Bests","Worsts",
                             paste0("Position_Lag",1:20),
                             paste0("Position_Lag",1:20,"_Bin"),
                             sapply(seq(1,20,5),function(lag) paste0("Position_Lag",lag,"to",lag+4)),
                             "Variance")
features_points_lag15 <- c("Bests","Worsts",
                           paste0("RankingPoints_Lag",1:15),
                           paste0("RankingPoints_Lag",1:15,"_Bin"),
                           sapply(seq(1,15,5),function(lag) paste0("RankingPoints_Lag",lag,"to",lag+4)),
                           "Variance")
features_points_lag20 <- c("Bests","Worsts",
                           paste0("RankingPoints_Lag",1:20),
                           paste0("RankingPoints_Lag",1:20,"_Bin"),
                           sapply(seq(1,20,5),function(lag) paste0("RankingPoints_Lag",lag,"to",lag+4)),
                           "Variance")
```

# Predictions of week to predict

```{r}
target <- target_points
features <- features_points_lag20
test_xgbDMatrix <- xgb.DMatrix(data=data.matrix(data_points_lag20[,features]))
data_points_lag20[,target] <- predict(model_XGB,test_xgbDMatrix)
```

# Output Azure
```{r}
output <- data_points_lag20[,c("Golfer","Week",target)]

# Select data.frame to be sent to the output Dataset port
# maml.mapOutputPort("output")
```